<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git-Backed Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px auto;
            max-width: 800px;
            padding: 0 20px;
            text-align: center;
        }
        h1 {
            color: #333;
        }
        .chat-container {
            margin-top: 30px;
            text-align: left;
        }
        .messages {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-time {
            color: #666;
            font-size: 0.8em;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Git-Backed Chat</h1>
    <p class="status">Server Status: <span id="status">Running</span></p>
    <p class="status">Current time: <span id="time"></span></p>

    <div class="chat-container">
        <div class="messages" id="messages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type your message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Display current time
        function updateTime() {
            const now = new Date();
            document.getElementById('time').textContent = now.toLocaleString();
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Global variables for message handling
        let isLoading = false;
        let lastMessageTimestamp = null;
        const messageRefreshInterval = 3000; // 3 seconds

        // Send message function
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const button = document.querySelector('button');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            // Disable input and button while sending
            input.disabled = true;
            button.disabled = true;
            isLoading = true;

            try {
                const timestamp = new Date().toISOString();
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: message,
                        timestamp: timestamp
                    })
                });

                if (response.ok) {
                    // Clear input and immediately display the message
                    input.value = '';
                    await loadMessages();
                } else {
                    const error = await response.text();
                    showError(`Failed to send message: ${error}`);
                }
            } catch (error) {
                showError(`Error sending message: ${error.message}`);
            } finally {
                // Re-enable input and button
                input.disabled = false;
                button.disabled = false;
                isLoading = false;
                input.focus();
            }
        }

        // Load messages function
        async function loadMessages() {
            if (isLoading) return;
            
            isLoading = true;
            const statusElement = document.getElementById('status');

            try {
                const response = await fetch('/api/messages');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const messages = await response.json();
                
                // Update status
                statusElement.textContent = 'Connected';
                statusElement.style.color = '#28a745';
                
                // Sort messages by timestamp
                messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = messages.map(msg => `
                    <div class="message">
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-time">
                            ${new Date(msg.timestamp).toLocaleString()}
                            ${msg.git_commit_hash ? `(Git: ${msg.git_commit_hash.substring(0, 7)})` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Only scroll if we're at the bottom or have new messages
                const shouldScroll = messagesDiv.scrollTop + messagesDiv.clientHeight >= messagesDiv.scrollHeight - 50;
                if (shouldScroll) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
                
                // Update last message timestamp
                if (messages.length > 0) {
                    lastMessageTimestamp = messages[messages.length - 1].timestamp;
                }
            } catch (error) {
                console.error('Error:', error);
                statusElement.textContent = 'Disconnected';
                statusElement.style.color = '#dc3545';
            } finally {
                isLoading = false;
            }
        }

        // Helper function to escape HTML and prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error';
            errorDiv.innerHTML = `<div class="message-content">${escapeHtml(message)}</div>`;
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.appendChild(errorDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Remove error message after 5 seconds
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Load messages on page load
        loadMessages();
        
        // Refresh messages periodically
        setInterval(loadMessages, messageRefreshInterval);

        // Handle Enter key in input
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Add some CSS for error messages
        const style = document.createElement('style');
        style.textContent = `
            .message.error {
                background: #fff3f3;
                border-left: 3px solid #dc3545;
            }
            .message.error .message-content {
                color: #dc3545;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
